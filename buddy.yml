- pipeline: "Deploy"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  ref_type: "BRANCH"
  target_site_url: "https://pizzabot.makavaf.al"
  clone_depth: 5
  actions:

  - action: "Upload files"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "/"
    remote_path: "/home/${ssh_username}/deploy-cache"
    login: "${ssh_username}"
    host: "${hostname}"
    port: "${ssh_port}"
    env_key: "id_rsa"
    authentication_mode: "ENV_KEY"

  - action: "Link current revision"
    type: "SSH_COMMAND"
    working_directory: "/home/${ssh_username}"
    login: "${ssh_username}"
    host: "${hostname}"
    port: "${ssh_port}"
    env_key: "id_rsa"
    authentication_mode: "ENV_KEY"
    commands:
    - "if [ -d \"releases/${execution.to_revision.revision}\" ] && [ \"${execution.refresh}\" = \"true\" ];"
    - "then"
    - " echo \"Removing: releases/${execution.to_revision.revision}\""
    - " rm -rf releases/${execution.to_revision.revision};"
    - "fi"
    - "if [ ! -d \"releases/${execution.to_revision.revision}\" ];"
    - "then"
    - " echo \"Creating: releases/${execution.to_revision.revision}\""
    - " cp -dR deploy-cache releases/${execution.to_revision.revision};"
    - "fi"
    - "echo \"Linking current to revision: ${execution.to_revision.revision}\""
    - "rm -f current"
    - "ln -s releases/${execution.to_revision.revision} current"
    - "echo \"Removing old releases\""
    - "cd releases && ls -t | tail -n +11 | xargs rm -rf"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"

  - action: "Build Python dependencies"
    type: "SSH_COMMAND"
    working_directory: "/home/${ssh_username}/current"
    login: "${ssh_username}"
    host: "${hostname}"
    port: "${ssh_port}"
    env_key: "id_rsa"
    authentication_mode: "ENV_KEY"
    commands:
    - "pipenv install"
    trigger_condition_paths:
    - "Pipfile.lock"
    shell: "BASH"
    trigger_condition: "ON_CHANGE_AT_PATH"

  - action: "Migrate database and reload Django app"
    type: "SSH_COMMAND"
    working_directory: "/home/${ssh_username}/current"
    login: "${ssh_username}"
    host: "${hostname}"
    port: "${ssh_port}"
    env_key: "id_rsa"
    authentication_mode: "ENV_KEY"
    commands:
    - "pipenv run django-admin migrate --settings=pizzabot.conf.settings.production"
    - "touch /etc/uwsgi/vassals/pizzabot.ini"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"

  - action: "Verify API reachability"
    type: "WEB"
    headers:
    - name: "User-Agent"
      value: "Buddy"
    text: "Tackar som fr√•gar!"
    text_existence: true
    destination: "https://${hostname}/-/"
    trigger_condition: "ALWAYS"

  - action: "Record deploy"
    type: "ROLLBAR"
    user: "$BUDDY_INVOKER_NAME"
    rollbar_username: "Majsvaffla"
    application_name: "pizzabot"
    environment: "production"
    application_id: "210904"
    comment: "$BUDDY_EXECUTION_REVISION - $BUDDY_EXECUTION_REVISION_MESSAGE"
    token: "${ROLLBAR_ACCESS_TOKEN}"
    token_name: "post_server_item"
    trigger_condition: "ALWAYS"
    integration_id: 35764